bash -c "cat << 'EOF' > src/phase3_fine_tune.py
import numpy as np
from scipy.integrate import odeint
import matplotlib.pyplot as plt
import pandas as pd

# --- CONSTANTS ---
H0 = 67.4
OM_PLANCK = 0.315
OL_PLANCK = 0.685
OR_PLANCK = 8e-5
C_LIGHT = 3e5

def get_eos_varying(a, params):
    \"\"\"
    params = (peak_cs, z_crit)
    \"\"\"
    c_s_val, z_c = params
    z = (1.0/a) - 1.0
    
    # Sigmoid Activation
    # We use a sharper transition (factor 4.0) to strictly separate epochs
    weight = 1.0 / (1.0 + np.exp(4.0 * (z - z_c)))
    
    c_s = c_s_val * weight
    w = (c_s / C_LIGHT)**2
    return w, c_s

def physics_engine(y, a, k_mode, params):
    rho, d, dd = y
    w, c_s = get_eos_varying(a, params)
    
    drho_da = -3 * (rho / a) * (1 + w)
    
    E_sq = (OR_PLANCK / a**4) + rho + OL_PLANCK
    H = H0 * np.sqrt(E_sq)
    dH = (H0**2 / (2*H)) * (-4*OR_PLANCK/a**5 + drho_da)
    
    # Pressure
    pressure = (c_s / H)**2 * (k_mode**2 / a**2) * d
    
    friction = (3/a + dH/H) * dd
    gravity = 1.5 * rho * (H0 / H)**2 / a**2 * d
    
    d_dd = gravity - friction - pressure
    return [drho_da, dd, d_dd]

def run_fine_tune():
    print('Phase 3e: 2D Parameter Sweep (Speed vs. Timing)')
    print('Searching for the \"Survival Epoch\"...')
    print('--------------------------------------------------------------------------------')
    print(f'{\"Speed (km/s)\":<12} | {\"Transition (z)\":<15} | {\"S8 (k=0.7)\":<12} | {\"Dwarf (k=10)\":<12} | {\"Status\"}')
    print('--------------------------------------------------------------------------------')
    
    # 2D Grid
    cs_range = [30, 40, 50, 60]
    z_range = [2.0, 1.5, 1.0, 0.7, 0.5]
    
    a_range = np.logspace(-3, 0, 400)
    rho_init = OM_PLANCK * (a_range[0])**-3 
    y0 = [rho_init, 1e-3, 1e-3]
    
    # CDM Baseline
    sol_cdm = odeint(physics_engine, y0, a_range, args=(1.0, (0.0, 10.0)))
    growth_cdm = sol_cdm[-1, 1]
    
    results = []
    
    for z_c in z_range:
        for c_s in cs_range:
            params = (c_s, z_c)
            
            # S8 Scale
            sol_s8 = odeint(physics_engine, y0, a_range, args=(0.7, params))
            r_s8 = sol_s8[-1, 1] / growth_cdm
            
            # Dwarf Scale
            sol_dwarf = odeint(physics_engine, y0, a_range, args=(10.0, params))
            r_dwarf = sol_dwarf[-1, 1] / growth_cdm
            
            # Verdict Logic
            status = \"FAIL\"
            
            # 1. Survival Check
            if r_dwarf > 0.5:
                # 2. Tension Check
            	if 0.92 <= r_s8 <= 0.97:
                	status = \"!!! UNIFIED !!!\"
               	elif r_s8 < 0.92:
               		status = \"S8 Strong\"
               	elif r_s8 > 0.97:
               		status = \"S8 Weak\"
            else:
               	status = \"Dwarf Death\"
                
            print(f'{c_s:<12} | {z_c:<15} | {r_s8:<12.4f} | {r_dwarf:<12.4f} | {status}')
            results.append({'cs': c_s, 'z_c': z_c, 's8': r_s8, 'dwarf': r_dwarf})

    # Save to CSV for analysis
    df = pd.DataFrame(results)
    df.to_csv('output/fine_tune_results.csv', index=False)
    print('\\nResults saved to output/fine_tune_results.csv')

    # Visualizing the Best 'z' for a fixed 'cs=40'
    best_z = df[df['cs'] == 40]
    plt.figure(figsize=(10,6))
    plt.plot(best_z['z_c'], best_z['s8'], 'o-', label='S8 (k=0.7)')
    plt.plot(best_z['z_c'], best_z['dwarf'], 's-', label='Dwarfs (k=10)')
    plt.axhspan(0.92, 0.97, color='green', alpha=0.1, label='S8 Target Zone')
    plt.axhline(0.5, color='red', linestyle='--', label='Dwarf Survival')
    plt.xlabel('Transition Redshift (z_c)')
    plt.ylabel('Growth Ratio (USDM/CDM)')
    plt.title('The Impact of Transition Timing (fixed c_s=40 km/s)')
    plt.gca().invert_xaxis() # High z (left) to Low z (right)
    plt.legend()
    plt.grid(True, alpha=0.3)
    plt.savefig('output/phase3_timing.png')

if __name__ == '__main__':
    run_fine_tune()
EOF
python3 src/phase3_fine_tune.py"